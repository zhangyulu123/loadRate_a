<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv = "X-UA-Compatible" content = "IE = edge" charset = "UTF-8"/> 
		<title>ActualLoadRate</title>
		<link rel = "stylesheet" href = "../src/main/webapp/pages/css/wanma.css"/>
		<link rel = "stylesheet" href = "../src/main/webapp/tools/easyui/themes/default/easyui.css"/>
		<link rel = "stylesheet" href = "../src/main/webapp/tools/easyui/themes/icon.css"/>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/tssJS/tssJS.all.js"></script>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/jquery.min.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/jquery.easyui.min.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/easyui-lang-zh_CN.js"></script>
		<!--
		<script type = "text/javascript" src = "../src/main/webapp/tools/echarts/echarts-all-2.1.10.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/more/bi_template/echart.js"></script>-->
		<script type = "text/javascript" src = "../src/main/webapp/more/bi_template/common.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/pages/js/common.js"></script>
		<style type = "text/css">
			html, body {
				height: 100%
			}
			
			#tb {
				padding-bottom: 5px;
				padding-top: 5px;
				padding-left: 25px;
			}
		</style>
		<script type = "text/javascript">
		
			var data1,data2,data3,
				method = "POST", 
				DATA_URL_1 = "http://10.9.45.68:8080/tss/data/json/2150", //实际装载率
				DATA_URL_2 = "http://10.9.45.68:8080/tss/data/json/2153", //理论装载率
				DATA_URL_3 = "http://10.9.45.68:8080/tss/data/json/2163", //差值
				params = {"param1": "2016-10-20"};
			var d = parseInt(params.param1.split("-")[2]);
			
			//动态列名个数（时间区间）,默认只取参数当月
			var var_cols = function(){
				var daylist = [];
				for(var i = d; i > 0 ; i--){
					y = params.param1.substr(0,params.param1.length-2)+ ((i > 9)?i:("0"+i));
					daylist.push(y);
				}
				return daylist;
			}
			
			//理论装载率列名，list为对应的中文名
			var Theory_title = function(){
				var cols = [];
				cols.push({field: "shuttle", title: "班车号", width: "8%", align: "center"});
				cols.push({field: "route_name", title: "车线名称", width: "8%", align: "center"});
				cols.push({field: "route_type", title: "车线类型", width: "8%", align: "center"});
				cols.push({field: "truck_type", title: "车型", width: "8%", align: "center"});
				cols.push({field: "route", title: "分段线路", width: "8%", align: "center"});
				cols.push({field: "w1", title: "ab(bc)货量", width: "8%", align: "center"});
				cols.push({field: "w2", title: "ac货量", width: "8%", align: "center"});
				cols.push({field: "weight", title: "分段货量", width: "8%", align: "center"});
				cols.push({field: "rate", title: "分段装载率", width: "8%", align: "center"});
				return cols;
			}
			
			var Actual_title = function(){
				var cols = [], temp = [];
				temp.push({field: "shuttle", title: "班车号", rowspan: 2, width: "8%", align: "center"});
				temp.push({field: "route_name", title: "规划车线", rowspan: 2, width: "8%", align: "center"});
				temp.push({field: "route", title: "分段线路", rowspan: 2, width: "8%", align: "center"});
				temp.push({field: "day", title: "月均值", width: "8%", colspan: 2, align: "center"});
				for(var i = 0; i < var_cols.length; i++){
					temp.push({field: "day"+i+1, title: var_cols[i], width: "8%", colspan: 2, align: "center"});
				}
				cols.push(temp);
				temp = [];
				for(var i = 0; i <= var_cols.length; i++){
					temp.push({field: "weight"+i, title: "货量", width: "8%", align: "center"});
					temp.push({field: "rate"+i, title: "装载率", width: "8%", align: "center"});
				}
				cols.push(temp);
				return cols;
			}
			
			//cols选择的日期动态列
			var Diff_title = function(cols){
				var cols = [], temp = [];
				temp.push({field: "shuttle", title: "班车号", rowspan: 2, width: "8%", align: "center"});
				temp.push({field: "route_name", title: "规划车线", rowspan: 2, width: "8%", align: "center"});
				temp.push({field: "model", title: "经停模式", rowspan: 2, width: "8%", align: "center"});
				temp.push({field: "truck_type", title: "车型", width: "8%", colspan: 2, align: "center"});
				temp.push({field: "route", title: "分段线路", width: "8%", colspan: 2, align: "center"});
				for(var i = 0; i < var_cols.length; i++){
					temp.push({field: "day"+i+1, title: var_cols[i], width: "8%", colspan: 2, align: "center"});
				}
				cols.push(temp);
				temp = [];
				for(var i = 0; i < cols.length; i++){
					temp.push({field: "r_th"+i+1, title: "理论装载率", width: "8%", align: "center"});
					temp.push({field: "r_ac"+i+1, title: "实际装载率", width: "8%", align: "center"});
				}
				cols.push(temp);
				return cols;
			}
				
			$(function(){
			
				//理论装载率日期框初始值
				$("input[required='required']:first").datebox('setValue', params.param1.substr(0,params.param1.length-2)+ ((d > 9)?d:("0"+d)));
				
				//差值日期框初始值
				$("input[required='required']:eq(1)").datebox('setValue', params.param1.substr(0,params.param1.length-2)+ ((d-7>0)?((d-7>9)?(d-7):("0"+(d-7))):"01"));
				$("input[required='required']:last").datebox('setValue', params.param1.substr(0,params.param1.length-2)+ ((d > 9)?d:("0"+d)));
				tssJS.ajax({
					url: DATA_URL_3,
					params: params,
					method: method,
					type: "json",
					waiting: true,
					ondata: function(){
						data3 = this.getResponseJSON();
						//date = $("input[required='required']:first").datebox('getValue');
						//var func = TheoryGrid(data2, date, "鞍山-沈阳-鞍山");	
						from_date = $("input[required='required']:eq(1)").datebox('getValue');
						to_date = $("input[required='required']:last").datebox('getValue');
						//DiffGrid(data3, from_date, to_date);	
					}
				});
				
				//差值分析查询按钮
				$(".search:last").click(function(){
					func = DiffGrid(data3, from_date, to_date);
				})
				
			})
				
			
/*			
			$(function(){
			
				tssJS.ajax({
					url: DATA_URL,
					params: params,
					method: method,
					type: "json",
					waiting: true,
					ondata: function(){
						data1 =  this.getResponseJSON();
						f1 = showGrid(data);
						$("#real").datagrid({
							toolbar: "#tb",
							fit: true,
							pagination:true, 
							//title: params.param1.split('-')[0]+params.param1.split('-')[1]+"货量装载率统计",
							frozenColumns:[f1[0][0].slice(0,4), f1[0][1].slice(0,2)],
							columns: [f1[0][0].slice(4), f1[0][1].slice(2)],
							data: f1[1].slice(0,20)
						});
						
						var page = $("#real").datagrid("getPager");
						$(page).pagination({
							total: f1[1].length,
							pageSize: 20,
							pageList: [20, 50, 100],
							beforePageText: '第',
							afterPageText: '页共 {pages} 页',
							displayMsg: '当前显示 {from} - {to} 条记录/共 {total} 条记录',
							onSelectPage:function (pageNo, pageSize) { 
								var start = (pageNo - 1) * pageSize; 
								var end = start + pageSize; 
								$("#real").datagrid("loadData", f1[1].slice(start, end)); 
								page.pagination('refresh', { 
									total:f1[1].length, 
									pageNumber:pageNo 
								}); 
							} 
						});
					}
				});	
				
				//展示界面信息导出
				$("#save").click(function(){
					$(this)[0].download = params.param1.split('-')[0]+params.param1.split('-')[1]+"货量装载率统计.csv";
					this.href = "data:text/csv;charset=utf-8,\ufeff" + encodeURIComponent(saveTable(f1));
				});
				
					
			});
*/			
			//理论装载率对象
			function theory_obj(shuttle,route_name,route_type,truck_type,route,w1,w2,weight,rate){
				this.shuttle = shuttle;
				this.route_name = route_name;
				this.route_type = route_type;
				this.truck_type = truck_type;
				this.route = route;
				this.w1 = w1;
				this.w2 = w2;
				this.weight = weight;
				this.rate = rate;
				return this;
			}
			
			//实际装载率动态列名对象
			function actual_obj(shuttle,route_name, route,cols){
				this.shuttle = shuttle;
				this.route_name = route_name;
				this.route = route;
				//0为累计项定义
				for(var i = 0; i <= cols.length; i++){
					eval("this.weight"+i+" = '-'");
					eval("this.rate"+i+" = '-'");
				}
				return  this;
			}
			//差值对象
			function diff_obj(shuttle, route_name, model, truck_type, route, cols){
				this.shuttle = shuttle;
				this.route_name = route_name;
				this.model = model;
				this.truck_type = truck_type;
				this.route = route;
				for(var i = 1; i <= cols.length; i++){
					eval("this.r_ac"+i+" = '-'");
					eval("this.r_th"+i+" = '-'");
				};
				return this;
			}
			
			//理论装载率
			function TheoryGrid(data, date, route){
				var json = {}, rows = [];
				var temp;
				$.each(data, function(i,item){
					if(item.day == date){
						if(route == ""){
							temp = new theory_obj(item.shuttle_code,item.route_name,item.route_type,item.truck_type,item.route,item.w1,item.w2,item.weight,item.rate);
							rows.push(temp);
						}else{
							if(item.route_name == route){
								temp = new theory_obj(item.shuttle_code,item.route_name,item.route_type,item.truck_type,item.route,item.w1,item.w2,item.weight,item.rate);
								rows.push(temp);
							}
						}
					}
				});
				json["total"] = rows.length;
				json["rows"] = rows;
				return json;
			}
			
			//实际装载率
			function ActualGrid(data,route){
				var json = {}, rows = [];
				var cols = var_cols();
				var temp, idx, sum_weight = 0, sum_rate = 0, j = 0;
				$.each(data, function(i, item){
					if((route != "" && item.route_name == route) || route == ""){
						if(temp == undefined){
							temp = new actual_obj(item.shuttle_code,item.route_name,item.in_to,cols);
						}
						if(temp.shuttle + "_" + temp.route != item.shuttle_code + "_" + item.in_to && j != 0){
							temp["weight0"] = sum_weight/j;
							temp["rate0"] = sum_rate/j;
							rows.push(temp);
							temp = new actual_obj(item.shuttle_code,item.route_name,item.in_to,cols);
							j = 0;
							sum_weight = 0;
							sum_rate = 0;
						}
						idx = $.inArray(item.day,cols)+1;
						eval("temp['weight"+idx+"'] = item.weight");
						eval("temp['rate"+idx+"'] = item.loadrate");
						sum_weight = sum_weight + item.weight;
						sum_rate = sum_rate + parseFloat(item.loadrate); 
						j = j + 1;
					}
				});
				temp["weight0"] = sum_weight/j;
				temp["rate0"] = sum_rate/j;
				rows.push(temp);
				
				json.total = rows.length;
				json.rows = rows;
				
				return json;
			}
			
			//理论实际差值,返回json和查询日期表头
			function DiffGrid(data, from_date, to_date){
				var json = {}, rows = [], cols = [];
				var temp, rule, idx;
				var keys = [], conditions = [], values = [], logic = [],str = "";
				
				//所有筛选条件值
				for(var i = 0; i < $(".values").length; i++){
					eval("keys.push($('.keys:nth("+ i +")').combobox('getValue'))");
					eval("conditions.push($('.conditions:nth("+ i +")').combobox('getText'))");
					eval("values.push($('.values:nth("+ i +")').textbox('getValue'))");
					if(i > 0){
						eval("logic.push($('.logic:nth("+ (i-1) +")').combobox('getValue'))");
					}
				}
				
				//日期时间区间
				from_date = parseInt(from_date.split("-")[2]);
				to_date = parseInt(to_date.split("-")[2]);
				for(var i = to_date; i >= from_date; i--){
					cols.push((params.param1.substr(0,params.param1.length-2)+(i>9?i:"0"+i)));
				}
				$.each(data, function(i, item){
					var day = parseInt(item.day.split("-")[2]);
					if(day >= from_date && day <= to_date){
						//载筛选条件值不为空
						if(values[0] != ""){
							for(var j = 0; j < values.length-1; j++){
								str += "item."+keys[j]+conditions[j]+values[j]+logic[j];
							}
							eval("rule = " + str + "item."+keys[j]+conditions[j]+values[j]);
						};
						if(rule || rule == undefined){
							if(temp == undefined){
								temp = new diff_obj(item.shuttle_code, item.route_name, item.model, item.truck_type, item.in_to, cols);
							};
							if(temp.shuttle + "_" + temp.route != item.shuttle_code + "_" + item.in_to){
								rows.push(temp);
								temp = new diff_obj(item.shuttle_code, item.route_name, item.model, item.truck_type, item.in_to, cols);
							}
							idx = $.inArray(item.day,cols)+1;
							eval("temp['r_ac"+idx+"'] = item.r_ac");
							eval("temp['r_th"+idx+"'] = item.r_th");
						}
					}
				})
				rows.push(temp);
				
				json.total = rows.length;
				json.rows = rows;
				
				return [json, cols];
			}
			
			//增加(1)或删除(0)查询行
			function filter(obj, func){
				if(func == 1){
					var str = "<span class = 'filter'><select class = 'easyui-combobox logic'><option value = '&&'>并且</option><option value = '||'>或者</option></select><select class = 'easyui-combobox keys' style = 'width: 100px'>"+"<option value = 'route_name' checked = 'checked'>车线名称</option>"+
						  "<option value = 'r_th'>理论装载率</option>" + "<option value = 'r_ac'>实际装载率</option></select>" + 
						  "<select class = 'easyui-combobox conditions' style = 'width: 40px'>" + "<option value = 1 checked = 'checked'>=</option>"+
						  "<option value = 2>&gt;</option>" + "<option value = 3>&lt;</option>" + "<option value = 4>&gt;=</option>" +
						  "<option value = 5>&lt;=</option></select>" + "<input class='easyui-textbox values' style = 'width: 100px'/></span>";
					$(obj).before(str);	
					//重新渲染
					$.parser.parse($("#tb3 .filter:last"));
				}else{
					$("#tb3 .filter:last").remove();
				}
			}
			
			function print_data(json, title){
				
			}
/*			
			function showGrid(data){
				var daylist = [], gridData = [], route_obj = {};
				$.each(data, function(i, item){
					var t = item.schedule_id+"_"+item.route_name+"_"+item.in_to;
					if(!daylist.contains(item.day)){
						daylist.push(item.day);
					};
					if(!route_obj.hasOwnProperty(t)){
						route_obj[t] = [];
					}
					route_obj[t].push({"day": item.day, "weight": item.weight, "loadrate": item.loadrate});
				});
				
				
				for(var key in route_obj){
					var avg_w = 0, avg_r = 0, temp = {}, j = 0;
					 temp["id"] = key.split("_")[0];
					 temp["route_name"] = key.split("_")[1];
					 temp["route_split"] = key.split("_")[2];
					 temp["weight"] = 0, temp["loadrate"] = 0;
					for(var i = 0; i < daylist.length; i++){
						if(route_obj[key][j] != undefined && daylist[i] == route_obj[key][j]["day"]){
							temp["weight"+i] = route_obj[key][j]["weight"];
							temp["loadrate"+i] = route_obj[key][j]["loadrate"];
							avg_w += route_obj[key][j]["weight"];
							avg_r += parseFloat(route_obj[key][j]["loadrate"].substr(0, route_obj[key][j]["loadrate"].length-1));
							j++;
						}else{
							//缺失值处理
							temp["weight"+i] = '-';
							temp["loadrate"+i] = '-';
						}
		
					}
					avg_w = avg_w/j;
					avg_r = avg_r/j;
					temp["weight"] = Math.round(avg_w*100)/100;
					temp["loadrate"] = Math.round(avg_r*100)/100+"%";
					gridData.push(temp);
				}
				
				//列名
				var chtml = [], chtml1 = [], chtml2 = [];
				
				chtml1 = [{field: "id", title: "班车编码", width: "8%", rowspan: 2, align: "center"},
				{field: "route_name", title: "规划线路", width: "8%", rowspan: 2, align: "center"},
				{field: "route_split", title: "分段线路", width: "8%", rowspan: 2, align: "center"}];
				
				chtml1.push({field: "day", title: "月均值", width: "8%", colspan: 2, align: "center"});
				chtml2.push({field: "weight", title: "月均货量", width: "5%", align: "right"});
				chtml2.push({field: "loadrate", title: "月均装载率", width: "5%", align: "right", formatter: val_style});
				
				for(i = 0; i < daylist.length; i++){
					chtml1.push({field: "day"+i, title: daylist[i], width: "8%", colspan: 2, align: "center"});
					chtml2.push({field: "weight"+i, title: "货量", width: "5%", align: "right"});
					chtml2.push({field: "loadrate"+i, title: "装载率", width: "5%", align: "right", formatter: val_style});
				}
				
				chtml.push(chtml1);
				chtml.push(chtml2);
				
				return [chtml, gridData];
			}
			
			//汇总表导出
			function saveTable(data){
				var str = "";
				var title = data[0]
				var cols = data[1];
				
				//thead
				for(var i = 0; i < data[0][0].length; i++){
					if(i < 3){
						str += data[0][0][i]["title"]+",";
					}else{
						str += data[0][0][i]["title"]+","+""+",";
					}
					
				}
				str = str.substr(0, str.length-1) + "\n"+""+","+""+","+""+",";
				for(j = 0; j < data[0][1].length; j++){
					str += data[0][1][j]["title"]+",";
				}
				str = str.substr(0, str.length-1) + "\n";
				
				//tbody
				for(var k = 0; k < data[1].length; k++){
					for(var key in data[1][k]){
						str += 	data[1][k][key]+",";
					}
					str = str.substr(0, str.length-1) + "\n";
					
				}
				return str;
			}	
			
			function val_style(value, row, index){
				if(parseFloat(value.substr(0, value.length-1)) > 85){
					return '<span style="color:red;font-weight:bold">'+value+'</span>';
				}else if(parseFloat(value.substr(0, value.length-1)) < 40){
					return '<span style="color:green;font-weight:bold">'+value+'</span>';
				}else{
					return value;
				}
			};
			
			function filter(){
				var f1 = showGrid(data),
					filter_data = [],
					filter_condition = $("#combo").combobox("getText");
					filter_text = $("#text").textbox("getText");
					for(var i = 0; i< f1[1].length; i++){
						if(filter_condition == "规划线路"){
							if(f1[1][i]["route_name"] == filter_text){
								filter_data.push(f1[1][i]);
							};
						}else if(filter_condition == "班车编码"){
							if(f1[1][i]["id"] == filter_text){
								filter_data.push(f1[1][i]);
							};
						}else{
							if(f1[1][i]["route_split"] == filter_text){
								filter_data.push(f1[1][i]);
							};
						};
					};
					
					$("#real").datagrid({
							toolbar: "#tb",
							fit: true,
							title: params.param1.split('-')[0]+params.param1.split('-')[1]+"货量装载率统计",
							frozenColumns:[f1[0][0].slice(0,4), f1[0][1].slice(0,2)],
							columns: [f1[0][0].slice(4), f1[0][1].slice(2)],
							data: {"total":filter_data.length, "rows":filter_data}
						});
			};
			
			function save_origin_data(data){
				var str = "";
				for(var key in data[0]){
					str += data[0][key] + ",";
				}
				str = str.substr(0, str.length-1) + "\n";
				for(var i = 1; i < data.length; i++){
					for(var key in data[i]){
						str += data[i][key] + ",";
					}
					str = str.substr(0, str.length-1) + "\n";
				}
				return str;
			}
*/				
		</script>
	<head>
	<body>
		<div id = "main" class = "easyui-tabs" fit = "true">
			<div title = "tab1" style = "height: 100%">
				<table id = "actual_loadrate"></table>
				<div id = "tb1" class = "tb">
					车线名称：&nbsp;&nbsp;
					<input class="easyui-textbox text" style = "width: 150px"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<a class="easyui-linkbutton search" iconCls="icon-search">查询</a>&nbsp;&nbsp;
					<a href="#" class="easyui-linkbutton save" iconCls="icon-save">导出</a>
				</div>
			</div>
			<div title = "tab2" style = "height: 100%">
				<table id = "theory_loadrate"></table>
				<div id = "tb2" class = "tb">
					日期: &nbsp;
					<input type="text" class="easyui-datebox dd" required="required">
					车线名称：&nbsp;
					<input class="easyui-textbox text" style = "width: 150px"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<a class="easyui-linkbutton search" iconCls="icon-search">查询</a>&nbsp;&nbsp;
					<a href="#"  class="easyui-linkbutton save" iconCls="icon-save">导出</a>
				</div>
			</div>	
			<div title = "tab3" style = "height: 100%">
				<table id = "diff_loadrate"></table>
				从日期：&nbsp;
				<input type="text" class="easyui-datebox dd" required="required">
				到日期：&nbsp;
				<input type="text" class="easyui-datebox dd" required="required">
				<div id = "tb3" class = "tb">
					查询条件：&nbsp;
					<span>
						<select class = "easyui-combobox keys" style = "width: 100px">
							<option value = "route_name" checked = "checked">车线名称</option>
							<option value = "r_th">理论装载率</option>
							<option value = "r_ac">实际装载率</option>
						</select>
						<select class = "easyui-combobox conditions" style = "width: 40px">
							<option value = 1 checked = "checked">=</option>
							<option value = 2>&gt;</option>
							<option value = 3>&lt;</option>
							<option value = 4>&gt;=</option>
							<option value = 5>&lt;=</option>
						</select>
						<input class="easyui-textbox values" style = "width: 100px"/>
					</span>
					<a class="easyui-linkbutton" iconCls = "icon-add" onclick = "add_filter(this,1);" ></a>
					<a class="easyui-linkbutton" iconCls = "icon-no" onclick = "del_filter(this,0);" ></a>
					<a class="easyui-linkbutton search" iconCls="icon-search" >查询</a>
					<a href="#" class="easyui-linkbutton save" iconCls="icon-save">导出</a>
				</div>	
			</div>
		</div>	
	</body>
</html>